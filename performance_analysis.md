# 性能分析报告

## 执行时间
2025-12-31

## 系统概览

### CPU 信息
- **CPU 核心数**: 4 核
- **当前频率**: 1.512 GHz (所有核心)
- **最大频率**: 1.512 GHz (可能被限制)
- **CPU 调频策略**: interactive
- **系统 CPU 使用率**: User 48%, System 15%

### 内存信息
- **总内存**: 1.8 GB
- **可用内存**: 972 MB
- **应用内存占用**: 132 MB
  - Java Heap: 67.7 MB
  - Native Heap: 12.3 MB
  - Graphics: 19 MB
  - Code: 14.7 MB

## 应用性能分析

### 1. 帧率性能（严重问题 ⚠️）

**关键指标**:
- **卡顿帧比例**: 48.76% (2629/5392 帧)
- **50th 百分位**: 15ms (目标: 16.67ms for 60fps)
- **90th 百分位**: 46ms (严重超标，应该是 <20ms)
- **95th 百分位**: 53ms (严重超标)
- **99th 百分位**: 85ms (非常严重)
- **平均帧延迟**: 31.2ms (目标: 16.67ms)

**问题分析**:
- **丢失垂直同步**: 1830 次 (导致画面撕裂和卡顿)
- **UI 线程慢**: 1157 次 (主线程阻塞)
- **绘制命令慢**: 567 次 (GPU 渲染瓶颈)
- **位图上传慢**: 3 次 (纹理上传问题)

**影响**: 用户体验严重下降，视频播放不流畅

### 2. CPU 使用情况

**应用 CPU 占用**:
- **当前占用**: 25% (单核满载)
- **总 CPU 时间**: 758.79 秒
- **线程数**: 40 个
- **进程状态**: Sleeping (S)

**线程上下文切换**:
- **主动切换**: 97,817 次
- **非主动切换**: 209,546 次 (非常高，说明线程竞争激烈)

**线程 CPU 时间分析** (Top 10):
1. **主线程 (16136)**: 340.83 秒 ⚠️ (最多，说明主线程有大量计算)
2. **线程 16199**: 225.79 秒 (可能是渲染线程或播放器线程)
3. **线程 16239**: 43.72 秒
4. **线程 16220**: 35.54 秒
5. **线程 16155**: 32.21 秒
6. **线程 16201**: 31.95 秒
7. **线程 16208**: 17.8 秒
8. **线程 16196**: 16.63 秒
9. **线程 16219**: 16.46 秒

**线程类型分布**:
- **RenderThread**: 3 个 (渲染线程，可能过多)
- **MediaCodec_loop**: 2 个 (媒体解码线程)
- **OkHttp 相关**: 4 个 (网络请求线程)
- **线程池线程**: 4+ 个 (pool-*-thread-*)
- **hwuiTask**: 2 个 (硬件 UI 任务线程)
- **其他**: Glide、JIT、Signal Catcher 等

**问题**: 
- **主线程 CPU 时间最多** (340.83 秒)，说明主线程执行了大量耗时操作
- 线程过多导致上下文切换开销大
- 非主动切换次数异常高 (209,546 次)，说明线程经常被抢占
- 3 个 RenderThread 可能过多，应该只需要 1-2 个

### 3. 内存使用情况

**内存分布**:
```
总内存: 132 MB
├── Java Heap: 67.7 MB (51%)
├── Graphics: 19 MB (14%)
├── Code: 14.7 MB (11%)
├── Native Heap: 12.3 MB (9%)
└── 其他: 18.3 MB (15%)
```

**分析**:
- 内存使用合理，未发现内存泄漏
- Graphics 内存 19MB 正常（视频播放和弹幕渲染）

### 4. 渲染性能

**SurfaceFlinger 缓存**:
- TextureCache: 5.3 MB / 64 MB (使用率低)
- LayerCache: 0 / 16 MB
- 当前图层: 1 个 (1920x1080)

**问题**: 纹理缓存使用率低，可能存在优化空间

## 性能瓶颈总结

### 🔴 严重问题

1. **帧率性能严重不足**
   - 48.76% 的帧都是卡顿帧
   - 平均帧延迟 31.2ms，远超 16.67ms 目标
   - 大量丢失垂直同步信号

2. **UI 线程阻塞**
   - 1157 次 UI 线程慢事件
   - 主线程执行耗时操作

3. **线程管理问题**
   - 40 个线程过多
   - 非主动上下文切换 209,546 次，竞争激烈

### 🟡 中等问题

1. **GPU 渲染瓶颈**
   - 567 次慢绘制命令
   - 可能需要在 GPU 端优化

2. **CPU 频率限制**
   - 所有核心都在 1.512 GHz
   - 可能被系统限制，影响性能

## 优化建议

### 1. 优化 UI 线程（高优先级）🔥

**问题**: UI 线程阻塞导致卡顿，主线程 CPU 时间 340.83 秒（最多）

**根本原因**:
- 主线程执行了大量耗时操作
- 弹幕帧更新可能过于频繁
- 可能存在同步等待操作

**建议**:
- **立即检查**: 使用 `StrictMode` 检测主线程阻塞
  ```java
  if (BuildConfig.DEBUG) {
      StrictMode.setThreadPolicy(new StrictMode.ThreadPolicy.Builder()
          .detectAll()
          .penaltyLog()
          .build());
  }
  ```
- **优化弹幕渲染**: 
  - 检查 `DanmuPresenter.updateDanmakuFrame()` 是否在主线程执行耗时操作
  - 考虑将弹幕计算移到后台线程，只将结果传递给主线程渲染
- **异步化操作**: 
  - 所有网络请求、文件 I/O、数据库操作必须在后台线程
  - 使用 `Handler` 或 `RxJava` 进行线程切换
- **减少主线程计算**: 
  - 避免在主线程进行复杂计算（如弹幕位置计算、字符串处理等）
  - 使用对象池减少对象创建

**代码位置**:
- `VideoPlayerActivity.java` - 检查主线程操作
- `DanmuPresenter.java` - 优化弹幕帧更新逻辑（当前使用 Choreographer，但计算可能仍耗时）
- `DanmuRenderer.java` - 优化弹幕渲染计算

### 2. 减少线程数量（高优先级）🔥

**问题**: 40 个线程过多，导致上下文切换开销大（非主动切换 209,546 次）

**具体问题**:
- 3 个 RenderThread 可能过多（通常只需要 1-2 个）
- 多个线程池线程可能可以合并
- 线程竞争激烈，导致频繁上下文切换

**建议**:
- **统一线程池**: 使用 `Executors.newFixedThreadPool()` 统一管理，避免创建过多线程
- **检查 RenderThread**: 3 个渲染线程可能过多，检查是否有不必要的渲染线程
- **合并相似功能**: 将相似功能的线程合并到同一个线程池
- **检查线程泄漏**: 确保所有线程在不需要时正确关闭
- **使用协程**: 如果使用 Kotlin，考虑使用协程替代线程

**代码检查点**:
- 检查所有 `new Thread()` 的地方
- 检查线程池的创建和管理
- 检查播放器库（ExoPlayer、IJKPlayer）的线程配置

### 3. 优化渲染性能（中优先级）

**问题**: GPU 绘制命令慢，丢失垂直同步

**建议**:
- 减少每帧的绘制调用
- 使用硬件加速
- 优化弹幕渲染，减少重绘区域
- 使用 `ViewStub` 延迟加载非关键视图
- 检查是否有过度绘制

**代码位置**:
- `DanmuOverlayView.java` - 优化弹幕绘制
- 检查是否有不必要的 `invalidate()` 调用

### 4. 优化帧率更新频率（中优先级）

**问题**: 弹幕帧更新可能过于频繁

**建议**:
- 当前使用 30fps 更新频率，可以进一步优化
- 使用 `Choreographer` 确保帧同步
- 避免在每帧都进行复杂计算

### 5. 监控和调试（低优先级）

**建议**:
- 使用 Android Profiler 进行实时性能监控
- 使用 `Systrace` 分析具体瓶颈
- 添加性能埋点，监控关键操作耗时

## 关键发现总结

### 🔴 最严重的问题

1. **主线程 CPU 占用最高 (340.83 秒)**
   - 主线程执行了大量耗时操作
   - 导致 49% 的帧都是卡顿帧
   - 1253 次 UI 线程慢事件

2. **帧率性能严重不足**
   - 卡顿帧比例: 49.01%
   - 平均帧延迟: 31.2ms (目标: 16.67ms)
   - 丢失垂直同步: 1979 次

3. **线程管理问题**
   - 40 个线程过多
   - 非主动上下文切换: 209,546 次
   - 3 个 RenderThread 可能过多

### 🟡 次要问题

1. **GPU 渲染瓶颈**: 599 次慢绘制命令
2. **CPU 频率限制**: 所有核心都在 1.512 GHz（可能被系统限制）

## 下一步行动

### 立即执行（今天）
1. ✅ **添加 StrictMode**: 检测主线程阻塞
2. ✅ **分析弹幕渲染**: 检查 `DanmuPresenter` 和 `DanmuRenderer` 的主线程操作
3. ✅ **性能监控**: 使用 Android Profiler 实时监控

### 短期优化（本周）
1. **优化弹幕渲染**: 将弹幕计算移到后台线程
2. **减少主线程计算**: 优化所有主线程的耗时操作
3. **线程池统一管理**: 减少线程数量

### 中期优化（本月）
1. **重构线程管理**: 统一使用线程池
2. **GPU 渲染优化**: 减少绘制命令，优化渲染流程
3. **性能测试**: 建立性能基准测试

### 长期优化（持续）
1. **代码审查**: 定期检查性能问题
2. **性能监控**: 建立性能监控体系
3. **持续优化**: 根据用户反馈持续优化

## 性能监控命令

```bash
# 实时监控 CPU 和内存
adb shell top -n 1 -d 1

# 查看应用内存详情
adb shell dumpsys meminfo com.mynas.nastv

# 查看帧率性能（需要先 reset）
adb shell dumpsys gfxinfo com.mynas.nastv reset
# 等待几秒后
adb shell dumpsys gfxinfo com.mynas.nastv

# 查看线程信息
adb shell ps -T -p <PID>

# 查看 CPU 频率
adb shell cat /sys/devices/system/cpu/cpu*/cpufreq/scaling_cur_freq
```

